#!/usr/bin/make -f
# -*- makefile -*-
SHELL := /bin/bash
DEB_BUILD_ARCH := $(shell dpkg-architecture -qDEB_BUILD_ARCH)
DEB_BUILD_ARCH_OS := $(shell dpkg-architecture -qDEB_BUILD_ARCH_OS)
DEB_BUILD_ARCH_BITS := $(shell dpkg-architecture -qDEB_BUILD_ARCH_BITS)
GEM_COMMAND := $(shell if [[ $$(which rvm) ]]; then echo "rvm system do gem"; else echo "/opt/metasploit/ruby/bin/ruby /opt/metasploit/ruby/bin/gem"; fi)
BUNDLE_COMMAND := $(shell if [[ $$(which rvm) ]]; then echo "rvm system do bundle"; else echo "/opt/metasploit/ruby/bin/ruby /opt/metasploit/ruby/bin/bundle"; fi)

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

%:
	dh $@

override_dh_clean:
	dh_clean --exclude=external/serialport/README.orig
	rm -rf debian/john
	rm -rf vendor/bundle

build: build-arch
build-arch: build_gems build_john

# Build binary gems
build_gems:
	set -e ; \
	GEM_TMP=$$( mktemp -d ) ; \
	HOME=$$GEM_TMP ${BUNDLE_COMMAND} config build.nokogiri --with-cflags=\"-O2 -pipe -w\" ; \
	HOME=$$GEM_TMP ${BUNDLE_COMMAND} install --without development test --path vendor/bundle ; \
	echo "BUNDLE_FROZEN: '1'" >> .bundle/config ; \
	rm -rf $$GEM_TMP ;

# Build John the Ripper Jumbo
build_john:
	mkdir -p debian/john
	tar -C debian/john -xjf data/john/src.tar.bz2
	set -e ; \
	cd debian/john/src ; \
	if [ "${DEB_BUILD_ARCH}" = "amd64" -o "${DEB_BUILD_ARCH}" = "x86_64" ]; then \
		mkdir ../run && make clean linux-x86-64   && mv ../run ../run.linux.x64.mmx  ; \
	elif [ "${DEB_BUILD_ARCH}" = "i386" -o "${DEB_BUILD_ARCH}" = "i686" ]; then \
		mkdir ../run && make clean linux-x86-mmx  && mv ../run ../run.linux.x86.mmx  ; \
		mkdir ../run && make clean linux-x86-sse2 && mv ../run ../run.linux.x86.sse2 ; \
		mkdir ../run && make clean linux-x86-any  && mv ../run ../run.linux.x86.any  ; \
	fi
	set -e ; \
	cd debian/john ; \
	for dir in $$(ls -d run*) ; do \
		if [ -d ../../data/john/$${dir} ] ; then \
			cp -n ../../data/john/$${dir}/* $${dir}/ ; \
		fi ; \
	done



override_dh_install:
	dh_install --exclude=armitage --exclude=data/armitage --exclude=msfgui --exclude=data/gui
	# Replace John the Ripper
	rm debian/metasploit-framework/usr/share/metasploit-framework/data/john/src.tar.bz2
	rm -r debian/metasploit-framework/usr/share/metasploit-framework/data/john/run.*
	set -e ; \
	if ls debian/john/run.* &> /dev/null ; then \
		cp -r debian/john/run.* debian/metasploit-framework/usr/share/metasploit-framework/data/john/ ; \
	fi
	mkdir -p debian/metasploit-framework/opt/metasploit/ruby/bin
	cp debian/extra/framework-ruby.sh debian/metasploit-framework/opt/metasploit/ruby/bin/framework-ruby
	chmod 0755 debian/metasploit-framework/opt/metasploit/ruby/bin/framework-ruby
	set -e ; \
	for binary in `ls msf*`; do \
		ln -s ../share/metasploit-framework/$${binary} debian/metasploit-framework/usr/bin/ ; \
	done
	echo "Note: Editing or removing this file may make updating very unstable" > debian/metasploit-framework/usr/share/metasploit-framework/.apt
	# Hard code shebang for tools scripts
	for binfile in $$(ls -d -1 debian/metasploit-framework/usr/share/metasploit-framework/tools/*.rb); do \
	  sed -i $${binfile} -e '1,1s=#!.*ruby=#!'"/opt/metasploit/ruby/bin/framework-ruby=" ; \
	done

override_dh_shlibdeps:
	dh_shlibdeps --exclude=/data/ --exclude=/modules/

override_dh_strip:
	dh_strip --exclude=/data/ --exclude=/modules/

# Skip these targets
override_dh_pysupport:
override_dh_perl:
