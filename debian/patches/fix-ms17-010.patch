From a4a9bc033a4efab59f562f8e685b41390f34c9d3 Mon Sep 17 00:00:00 2001
From: Spencer McIntyre <zeroSteiner@gmail.com>
Date: Fri, 8 Apr 2022 15:48:45 -0400
Subject: [PATCH 1/2] Fix building the SessionSetup request for MS17-010

RubySMB commit 8035d9c2 broke the exploit's SessionSetup request.
---
 modules/exploits/windows/smb/ms17_010_eternalblue.rb | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/modules/exploits/windows/smb/ms17_010_eternalblue.rb b/modules/exploits/windows/smb/ms17_010_eternalblue.rb
index 2b1d3ce85f83..e4930436f310 100644
--- a/modules/exploits/windows/smb/ms17_010_eternalblue.rb
+++ b/modules/exploits/windows/smb/ms17_010_eternalblue.rb
@@ -1571,8 +1571,10 @@ def make_smb1_free_hole_session_packet(flags2, vcnum, native_os)
     packet.parameter_block.max_mpx_count = 10
     packet.parameter_block.security_blob_length = 0
 
-    packet.data_block.native_os = native_os
-    packet.data_block.native_lan_man = "\x00" * 17
+    packet.smb_header.flags2.unicode = 0
+    packet.data_block.security_blob = native_os + "\x00" * 15
+    packet.data_block.native_os = ''
+    packet.data_block.native_lan_man = ''
     packet
   end
 

From 052e56174de76db84afc3bf2340e80b8e399421a Mon Sep 17 00:00:00 2001
From: Spencer McIntyre <zeroSteiner@gmail.com>
Date: Fri, 8 Apr 2022 18:26:49 -0400
Subject: [PATCH 2/2] Bump the version of RubySMB to 3.1

---
 Gemfile.lock                 | 4 ++--
 metasploit-framework.gemspec | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/Gemfile.lock b/Gemfile.lock
index 19ba85581aa9..6ad51c6ebc8e 100644
--- a/Gemfile.lock
+++ b/Gemfile.lock
@@ -74,7 +74,7 @@ PATH
       rex-text
       rex-zip
       ruby-macho
-      ruby_smb (~> 3.0)
+      ruby_smb (~> 3.1)
       rubyntlm
       rubyzip
       sinatra
@@ -445,7 +445,7 @@ GEM
     ruby-progressbar (1.11.0)
     ruby-rc4 (0.1.5)
     ruby2_keywords (0.0.5)
-    ruby_smb (3.0.6)
+    ruby_smb (3.1.0)
       bindata
       openssl-ccm
       openssl-cmac
diff --git a/metasploit-framework.gemspec b/metasploit-framework.gemspec
index 993e58599a9f..66c4f390d729 100644
--- a/metasploit-framework.gemspec
+++ b/metasploit-framework.gemspec
@@ -140,7 +140,7 @@ Gem::Specification.new do |spec|
   spec.add_runtime_dependency 'net-ssh'
   spec.add_runtime_dependency 'ed25519' # Adds ed25519 keys for net-ssh
   spec.add_runtime_dependency 'bcrypt_pbkdf'
-  spec.add_runtime_dependency 'ruby_smb', '~> 3.0'
+  spec.add_runtime_dependency 'ruby_smb', '~> 3.1'
   spec.add_runtime_dependency 'net-ldap'
   spec.add_runtime_dependency 'net-smtp'
   spec.add_runtime_dependency 'winrm'
